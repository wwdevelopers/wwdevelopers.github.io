/**

The MIT License (MIT)

Copyright (c) 2014 Maksim Surguy

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

**/function initialise(){createRenderer(),createScene(),createMesh(),addLights(),addEventListeners(),resize(container.offsetWidth,container.offsetHeight),animate(),trianglesReady()}function createRenderer(){webglRenderer=new FSS.WebGLRenderer,canvasRenderer=new FSS.CanvasRenderer,svgRenderer=new FSS.SVGRenderer,setRenderer(RENDER.renderer)}function setRenderer(e){switch(renderer&&output.removeChild(renderer.element),e){case WEBGL:renderer=webglRenderer;break;case CANVAS:renderer=canvasRenderer;break;case SVG:renderer=svgRenderer}renderer=svgRenderer,renderer.setSize(container.offsetWidth,container.offsetHeight),output.appendChild(renderer.element)}function createScene(){scene=new FSS.Scene}function createMesh(){scene.remove(mesh),renderer.clear(),geometry=new FSS.Plane(MESH.width*renderer.width,MESH.height*renderer.height,MESH.slices),material=new FSS.Material(MESH.ambient,MESH.diffuse),mesh=new FSS.Mesh(geometry,material),scene.add(mesh);var e,t;for(e=geometry.vertices.length-1;e>=0;e--)t=geometry.vertices[e],t.depth=Math.randomInRange(0,MESH.maxdepth/10),t.anchor=FSS.Vector3.clone(t.position)}function addLight(e,t,i,r,n){e=e!==void 0?e:LIGHT.ambient,t=t!==void 0?t:LIGHT.diffuse,i=i!==void 0?i:LIGHT.xPos,r=r!==void 0?r:LIGHT.yPos,n=n!==void 0?n:LIGHT.zOffset,renderer.clear(),light=new FSS.Light(e,t),light.ambientHex=light.ambient.format(),light.diffuseHex=light.diffuse.format(),light.setPosition(i,r,n),scene.add(light),LIGHT.diffuse=t,LIGHT.proxy=light,LIGHT.pickedup=!0,LIGHT.currIndex++}function addLights(){addLight(),LIGHT.count++}function trimLights(e){for(l=e;scene.lights.length>=l;l++)light=scene.lights[l],scene.remove(light),LIGHT.currIndex--;LIGHT.proxy=scene.lights[LIGHT.currIndex-1],LIGHT.pickedup=!1,renderer.clear()}function resize(e,t){renderer.setSize(e,t),FSS.Vector3.set(center,renderer.halfWidth,renderer.halfHeight),createMesh()}function animate(){update(),render(),requestAnimationFrame(animate)}function update(){var e,t,i=MESH.depth/100;for(e=geometry.vertices.length-1;e>=0;e--)t=geometry.vertices[e],FSS.Vector3.set(t.position,1,1,t.depth*i),FSS.Vector3.add(t.position,t.anchor);geometry.dirty=!0}function render(){renderer.render(scene)}function addEventListeners(){window.addEventListener("resize",onWindowResize),container.addEventListener("mousemove",onMouseMove)}function addControls(){var e,t,i;gui=new dat.GUI({autoPlace:!1}),controls.appendChild(gui.domElement),renderFolder=gui.addFolder("Render"),meshFolder=gui.addFolder("Mesh"),lightFolder=gui.addFolder("Light"),exportFolder=gui.addFolder("Export"),lightFolder.open(),i=renderFolder.add(RENDER,"renderer",{webgl:WEBGL,canvas:CANVAS,svg:SVG}),i.onChange(function(e){setRenderer(e)}),i=meshFolder.addColor(MESH,"ambient"),i.onChange(function(i){for(e=0,t=scene.meshes.length;t>e;e++)scene.meshes[e].material.ambient.set(i)}),i=meshFolder.addColor(MESH,"diffuse"),i.onChange(function(i){for(e=0,t=scene.meshes.length;t>e;e++)scene.meshes[e].material.diffuse.set(i)}),i=meshFolder.add(MESH,"width",.05,2),i.onChange(function(e){geometry.width!==e*renderer.width&&createMesh()}),i=meshFolder.add(MESH,"height",.05,2),i.onChange(function(e){geometry.height!==e*renderer.height&&createMesh()}),i=meshFolder.add(MESH,"depth",0,MESH.maxdepth).listen(),i=meshFolder.add(MESH,"slices",1,800),i.step(1),i.onChange(function(e){geometry.slices!==e&&createMesh()}),i=lightFolder.add(LIGHT,"currIndex",{1:1,2:2,3:3,4:4,5:5,6:6,7:7}).name("Current light").listen(),i.onChange(function(e){LIGHT.proxy=scene.lights[e-1],LIGHT.ambient=LIGHT.proxy.ambient.hex,LIGHT.diffuse=LIGHT.proxy.diffuse.hex,LIGHT.xPos=LIGHT.proxy.position[0],LIGHT.yPos=LIGHT.proxy.position[1],LIGHT.zOffset=LIGHT.proxy.position[2],gui.__folders.Light.__controllers[1].updateDisplay(),gui.__folders.Light.__controllers[2].updateDisplay()}),i=lightFolder.addColor(LIGHT,"ambient"),i.onChange(function(e){LIGHT.proxy.ambient.set(e),LIGHT.proxy.ambientHex=LIGHT.proxy.ambient.format()}),i=lightFolder.addColor(LIGHT,"diffuse"),i.onChange(function(e){LIGHT.proxy.diffuse.set(e),LIGHT.proxy.diffuseHex=LIGHT.proxy.diffuse.format()}),i=lightFolder.add(LIGHT,"count",1,7).listen(),i.step(1),i.onChange(function(e){scene.lights.length!==e&&(e>scene.lights.length?addLight():trimLights(e))}),i=lightFolder.add(LIGHT,"xPos",-mesh.geometry.width/2,mesh.geometry.width/2).listen(),i.step(1),i.onChange(function(e){LIGHT.proxy.setPosition(e,LIGHT.proxy.position[1],LIGHT.proxy.position[2])}),i=lightFolder.add(LIGHT,"yPos",-mesh.geometry.height/2,mesh.geometry.height/2).listen(),i.step(1),i.onChange(function(e){LIGHT.proxy.setPosition(LIGHT.proxy.position[0],e,LIGHT.proxy.position[2])}),i=lightFolder.add(LIGHT,"zOffset",0,1e3).name("Distance").listen(),i.step(1),i.onChange(function(e){LIGHT.proxy.setPosition(LIGHT.proxy.position[0],LIGHT.proxy.position[1],e)}),i=lightFolder.add(LIGHT,"randomize"),i=exportFolder.add(EXPORT,"width",100,3e3),i.step(100),i=exportFolder.add(EXPORT,"height",100,3e3),i.step(100),i=exportFolder.add(EXPORT,"export").name("export big"),i=exportFolder.add(EXPORT,"exportCurrent").name("export this")}function toggleEl(e){var t=document.getElementById(e);t.style.display="block"==t.style.display?"none":"block"}function getRandomColor(){return"#"+(Math.random().toString(16)+"000000").slice(2,8)}function onWindowResize(){resize(container.offsetWidth,container.offsetHeight),render()}function onMouseMove(e){LIGHT.pickedup&&(LIGHT.xPos=e.clientX-renderer.width/2,LIGHT.yPos=renderer.height/2-e.clientY,LIGHT.proxy.setPosition(LIGHT.xPos,LIGHT.yPos,LIGHT.proxy.position[2]))}var Delaunay;(function(){"use strict";function e(e){var t,i,r,n,o,s,a=Number.POSITIVE_INFINITY,h=Number.POSITIVE_INFINITY,l=Number.NEGATIVE_INFINITY,u=Number.NEGATIVE_INFINITY;for(t=e.length;t--;)a>e[t][0]&&(a=e[t][0]),e[t][0]>l&&(l=e[t][0]),h>e[t][1]&&(h=e[t][1]),e[t][1]>u&&(u=e[t][1]);return i=l-a,r=u-h,n=Math.max(i,r),o=a+.5*i,s=h+.5*r,[[o-20*n,s-n],[o,s+20*n],[o+20*n,s-n]]}function t(e,t,i,n){var o,s,a,h,l,u,c,d,f,S,g=e[t][0],m=e[t][1],p=e[i][0],F=e[i][1],b=e[n][0],y=e[n][1],v=Math.abs(m-F),L=Math.abs(F-y);if(r>v&&r>L)throw Error("Eek! Coincident points!");return r>v?(h=-((b-p)/(y-F)),u=(p+b)/2,d=(F+y)/2,o=(p+g)/2,s=h*(o-u)+d):r>L?(a=-((p-g)/(F-m)),l=(g+p)/2,c=(m+F)/2,o=(b+p)/2,s=a*(o-l)+c):(a=-((p-g)/(F-m)),h=-((b-p)/(y-F)),l=(g+p)/2,u=(p+b)/2,c=(m+F)/2,d=(F+y)/2,o=(a*l-h*u+d-c)/(a-h),s=v>L?a*(o-l)+c:h*(o-u)+d),f=p-o,S=F-s,{i:t,j:i,k:n,x:o,y:s,r:f*f+S*S}}function i(e){var t,i,r,n,o,s;for(i=e.length;i;)for(n=e[--i],r=e[--i],t=i;t;)if(s=e[--t],o=e[--t],r===o&&n===s||r===s&&n===o){e.splice(i,2),e.splice(t,2);break}}var r=1/1048576;Delaunay={triangulate:function(n,o){var s,a,h,l,u,c,d,f,S,g,m,p,F=n.length;if(3>F)return[];if(n=n.slice(0),o)for(s=F;s--;)n[s]=n[s][o];for(h=Array(F),s=F;s--;)h[s]=s;for(h.sort(function(e,t){return n[t][0]-n[e][0]}),l=e(n),n.push(l[0],l[1],l[2]),u=[t(n,F+0,F+1,F+2)],c=[],d=[],s=h.length;s--;d.length=0){for(p=h[s],a=u.length;a--;)f=n[p][0]-u[a].x,f>0&&f*f>u[a].r?(c.push(u[a]),u.splice(a,1)):(S=n[p][1]-u[a].y,f*f+S*S-u[a].r>r||(d.push(u[a].i,u[a].j,u[a].j,u[a].k,u[a].k,u[a].i),u.splice(a,1)));for(i(d),a=d.length;a;)m=d[--a],g=d[--a],u.push(t(n,g,m,p))}for(s=u.length;s--;)c.push(u[s]);for(u.length=0,s=c.length;s--;)F>c[s].i&&F>c[s].j&&F>c[s].k&&u.push(c[s].i,c[s].j,c[s].k);return u},contains:function(e,t){if(t[0]<e[0][0]&&t[0]<e[1][0]&&t[0]<e[2][0]||t[0]>e[0][0]&&t[0]>e[1][0]&&t[0]>e[2][0]||t[1]<e[0][1]&&t[1]<e[1][1]&&t[1]<e[2][1]||t[1]>e[0][1]&&t[1]>e[1][1]&&t[1]>e[2][1])return null;var i=e[1][0]-e[0][0],r=e[2][0]-e[0][0],n=e[1][1]-e[0][1],o=e[2][1]-e[0][1],s=i*o-r*n;if(0===s)return null;var a=(o*(t[0]-e[0][0])-r*(t[1]-e[0][1]))/s,h=(i*(t[1]-e[0][1])-n*(t[0]-e[0][0]))/s;return 0>a||0>h||a+h>1?null:[a,h]}},"undefined"!=typeof module&&(module.exports=Delaunay)})(),FSS={FRONT:0,BACK:1,DOUBLE:2,SVGNS:"http://www.w3.org/2000/svg"},FSS.Array="function"==typeof Float32Array?Float32Array:Array,FSS.Utils={isNumber:function(e){return!isNaN(parseFloat(e))&&isFinite(e)}},function(){for(var e=0,t=["ms","moz","webkit","o"],i=0;t.length>i&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[t[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[i]+"CancelAnimationFrame"]||window[t[i]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t){var i=(new Date).getTime(),r=Math.max(0,16-(i-e)),n=window.setTimeout(function(){t(i+r)},r);return e=i+r,n}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),Math.PIM2=2*Math.PI,Math.PID2=Math.PI/2,Math.randomInRange=function(e,t){return e+(t-e)*Math.random()},Math.clamp=function(e,t,i){return e=Math.max(e,t),e=Math.min(e,i)},FSS.Vector3={create:function(e,t,i){var r=new FSS.Array(3);return this.set(r,e,t,i),r},clone:function(e){var t=this.create();return this.copy(t,e),t},set:function(e,t,i,r){return e[0]=t||0,e[1]=i||0,e[2]=r||0,this},setX:function(e,t){return e[0]=t||0,this},setY:function(e,t){return e[1]=t||0,this},setZ:function(e,t){return e[2]=t||0,this},copy:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],this},add:function(e,t){return e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],this},addVectors:function(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],this},addScalar:function(e,t){return e[0]+=t,e[1]+=t,e[2]+=t,this},subtract:function(e,t){return e[0]-=t[0],e[1]-=t[1],e[2]-=t[2],this},subtractVectors:function(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],this},subtractScalar:function(e,t){return e[0]-=t,e[1]-=t,e[2]-=t,this},multiply:function(e,t){return e[0]*=t[0],e[1]*=t[1],e[2]*=t[2],this},multiplyVectors:function(e,t,i){return e[0]=t[0]*i[0],e[1]=t[1]*i[1],e[2]=t[2]*i[2],this},multiplyScalar:function(e,t){return e[0]*=t,e[1]*=t,e[2]*=t,this},divide:function(e,t){return e[0]/=t[0],e[1]/=t[1],e[2]/=t[2],this},divideVectors:function(e,t,i){return e[0]=t[0]/i[0],e[1]=t[1]/i[1],e[2]=t[2]/i[2],this},divideScalar:function(e,t){return 0!==t?(e[0]/=t,e[1]/=t,e[2]/=t):(e[0]=0,e[1]=0,e[2]=0),this},cross:function(e,t){var i=e[0],r=e[1],n=e[2];return e[0]=r*t[2]-n*t[1],e[1]=n*t[0]-i*t[2],e[2]=i*t[1]-r*t[0],this},crossVectors:function(e,t,i){return e[0]=t[1]*i[2]-t[2]*i[1],e[1]=t[2]*i[0]-t[0]*i[2],e[2]=t[0]*i[1]-t[1]*i[0],this},min:function(e,t){return t>e[0]&&(e[0]=t),t>e[1]&&(e[1]=t),t>e[2]&&(e[2]=t),this},max:function(e,t){return e[0]>t&&(e[0]=t),e[1]>t&&(e[1]=t),e[2]>t&&(e[2]=t),this},clamp:function(e,t,i){return this.min(e,t),this.max(e,i),this},limit:function(e,t,i){var r=this.length(e);return null!==t&&t>r?this.setLength(e,t):null!==i&&r>i&&this.setLength(e,i),this},dot:function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},normalise:function(e){return this.divideScalar(e,this.length(e))},negate:function(e){return this.multiplyScalar(e,-1)},distanceSquared:function(e,t){var i=e[0]-t[0],r=e[1]-t[1],n=e[2]-t[2];return i*i+r*r+n*n},distance:function(e,t){return Math.sqrt(this.distanceSquared(e,t))},lengthSquared:function(e){return e[0]*e[0]+e[1]*e[1]+e[2]*e[2]},length:function(e){return Math.sqrt(this.lengthSquared(e))},setLength:function(e,t){var i=this.length(e);return 0!==i&&t!==i&&this.multiplyScalar(e,t/i),this}},FSS.Vector4={create:function(e,t,i){var r=new FSS.Array(4);return this.set(r,e,t,i),r},set:function(e,t,i,r,n){return e[0]=t||0,e[1]=i||0,e[2]=r||0,e[3]=n||0,this},setX:function(e,t){return e[0]=t||0,this},setY:function(e,t){return e[1]=t||0,this},setZ:function(e,t){return e[2]=t||0,this},setW:function(e,t){return e[3]=t||0,this},add:function(e,t){return e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],e[3]+=t[3],this},multiplyVectors:function(e,t,i){return e[0]=t[0]*i[0],e[1]=t[1]*i[1],e[2]=t[2]*i[2],e[3]=t[3]*i[3],this},multiplyScalar:function(e,t){return e[0]*=t,e[1]*=t,e[2]*=t,e[3]*=t,this},min:function(e,t){return t>e[0]&&(e[0]=t),t>e[1]&&(e[1]=t),t>e[2]&&(e[2]=t),t>e[3]&&(e[3]=t),this},max:function(e,t){return e[0]>t&&(e[0]=t),e[1]>t&&(e[1]=t),e[2]>t&&(e[2]=t),e[3]>t&&(e[3]=t),this},clamp:function(e,t,i){return this.min(e,t),this.max(e,i),this}},FSS.Color=function(e,t){this.rgba=FSS.Vector4.create(),this.hex=e||"#000000",this.opacity=FSS.Utils.isNumber(t)?t:1,this.set(this.hex,this.opacity)},FSS.Color.prototype={set:function(e,t){e=e.replace("#","");var i=e.length/3;return this.rgba[0]=parseInt(e.substring(0*i,1*i),16)/255,this.rgba[1]=parseInt(e.substring(1*i,2*i),16)/255,this.rgba[2]=parseInt(e.substring(2*i,3*i),16)/255,this.rgba[3]=FSS.Utils.isNumber(t)?t:this.rgba[3],this},hexify:function(e){var t=Math.ceil(255*e).toString(16);return 1===t.length&&(t="0"+t),t},format:function(){var e=this.hexify(this.rgba[0]),t=this.hexify(this.rgba[1]),i=this.hexify(this.rgba[2]);return this.hex="#"+e+t+i,this.hex}},FSS.Object=function(){this.position=FSS.Vector3.create()},FSS.Object.prototype={setPosition:function(e,t,i){return FSS.Vector3.set(this.position,e,t,i),this}},FSS.Light=function(e,t){FSS.Object.call(this),this.ambient=new FSS.Color(e||"#FFFFFF"),this.diffuse=new FSS.Color(t||"#FFFFFF"),this.ray=FSS.Vector3.create()},FSS.Light.prototype=Object.create(FSS.Object.prototype),FSS.Vertex=function(e,t,i){this.position=FSS.Vector3.create(e,t,i)},FSS.Vertex.prototype={setPosition:function(e,t,i){return FSS.Vector3.set(this.position,e,t,i),this}},FSS.Triangle=function(e,t,i){this.a=e||new FSS.Vertex,this.b=t||new FSS.Vertex,this.c=i||new FSS.Vertex,this.vertices=[this.a,this.b,this.c],this.u=FSS.Vector3.create(),this.v=FSS.Vector3.create(),this.centroid=FSS.Vector3.create(),this.normal=FSS.Vector3.create(),this.color=new FSS.Color,this.polygon=document.createElementNS(FSS.SVGNS,"polygon"),this.polygon.setAttributeNS(null,"stroke-linejoin","round"),this.polygon.setAttributeNS(null,"stroke-miterlimit","1"),this.polygon.setAttributeNS(null,"stroke-width","1"),this.computeCentroid(),this.computeNormal()},FSS.Triangle.prototype={computeCentroid:function(){return this.centroid[0]=this.a.position[0]+this.b.position[0]+this.c.position[0],this.centroid[1]=this.a.position[1]+this.b.position[1]+this.c.position[1],this.centroid[2]=this.a.position[2]+this.b.position[2]+this.c.position[2],FSS.Vector3.divideScalar(this.centroid,3),this},computeNormal:function(){return FSS.Vector3.subtractVectors(this.u,this.b.position,this.a.position),FSS.Vector3.subtractVectors(this.v,this.c.position,this.a.position),FSS.Vector3.crossVectors(this.normal,this.u,this.v),FSS.Vector3.normalise(this.normal),this}},FSS.Geometry=function(){this.vertices=[],this.triangles=[],this.dirty=!1},FSS.Geometry.prototype={update:function(){if(this.dirty){var e,t;for(e=this.triangles.length-1;e>=0;e--)t=this.triangles[e],t.computeCentroid(),t.computeNormal();this.dirty=!1}return this}},FSS.Plane=function(e,t,i){FSS.Geometry.call(this),this.width=e||100,this.height=t||100;var r,n,o=Array(i);for(offsetX=this.width*-.5,offsetY=.5*this.height,s=o.length;s--;)r=offsetX+Math.random()*e,n=offsetY-Math.random()*t,o[s]=[r,n];o.push([offsetX,offsetY]),o.push([offsetX+e/2,offsetY]),o.push([offsetX+e,offsetY]),o.push([offsetX+e,offsetY-t/2]),o.push([offsetX+e,offsetY-t]),o.push([offsetX+e/2,offsetY-t]),o.push([offsetX,offsetY-t]),o.push([offsetX,offsetY-t/2]);for(var s=6;s>=0;s--)o.push([offsetX+Math.random()*e,offsetY]),o.push([offsetX,offsetY-Math.random()*t]),o.push([offsetX+e,offsetY-Math.random()*t]),o.push([offsetX+Math.random()*e,offsetY-t]);var a=Delaunay.triangulate(o);for(s=a.length;s;)--s,v1=new FSS.Vertex(Math.ceil(o[a[s]][0]),Math.ceil(o[a[s]][1])),--s,v2=new FSS.Vertex(Math.ceil(o[a[s]][0]),Math.ceil(o[a[s]][1])),--s,v3=new FSS.Vertex(Math.ceil(o[a[s]][0]),Math.ceil(o[a[s]][1])),t1=new FSS.Triangle(v1,v2,v3),this.triangles.push(t1),this.vertices.push(v1),this.vertices.push(v2),this.vertices.push(v3)},FSS.Plane.prototype=Object.create(FSS.Geometry.prototype),FSS.Material=function(e,t){this.ambient=new FSS.Color(e||"#444444"),this.diffuse=new FSS.Color(t||"#FFFFFF"),this.slave=new FSS.Color},FSS.Mesh=function(e,t){FSS.Object.call(this),this.geometry=e||new FSS.Geometry,this.material=t||new FSS.Material,this.side=FSS.FRONT,this.visible=!0},FSS.Mesh.prototype=Object.create(FSS.Object.prototype),FSS.Mesh.prototype.update=function(e,t){var i,r,n,o,s;if(this.geometry.update(),t)for(i=this.geometry.triangles.length-1;i>=0;i--){for(r=this.geometry.triangles[i],FSS.Vector4.set(r.color.rgba),n=e.length-1;n>=0;n--)o=e[n],FSS.Vector3.subtractVectors(o.ray,o.position,r.centroid),FSS.Vector3.normalise(o.ray),s=FSS.Vector3.dot(r.normal,o.ray),this.side===FSS.FRONT?s=Math.max(s,0):this.side===FSS.BACK?s=Math.abs(Math.min(s,0)):this.side===FSS.DOUBLE&&(s=Math.max(Math.abs(s),0)),FSS.Vector4.multiplyVectors(this.material.slave.rgba,this.material.ambient.rgba,o.ambient.rgba),FSS.Vector4.add(r.color.rgba,this.material.slave.rgba),FSS.Vector4.multiplyVectors(this.material.slave.rgba,this.material.diffuse.rgba,o.diffuse.rgba),FSS.Vector4.multiplyScalar(this.material.slave.rgba,s),FSS.Vector4.add(r.color.rgba,this.material.slave.rgba);FSS.Vector4.clamp(r.color.rgba,0,1)}return this},FSS.Scene=function(){this.meshes=[],this.lights=[]},FSS.Scene.prototype={add:function(e){return e instanceof FSS.Mesh&&!~this.meshes.indexOf(e)?this.meshes.push(e):e instanceof FSS.Light&&!~this.lights.indexOf(e)&&this.lights.push(e),this},remove:function(e){return e instanceof FSS.Mesh&&~this.meshes.indexOf(e)?this.meshes.splice(this.meshes.indexOf(e),1):e instanceof FSS.Light&&~this.lights.indexOf(e)&&this.lights.splice(this.lights.indexOf(e),1),this}},FSS.Renderer=function(){this.width=0,this.height=0,this.halfWidth=0,this.halfHeight=0},FSS.Renderer.prototype={setSize:function(e,t){return this.width!==e||this.height!==t?(this.width=e,this.height=t,this.halfWidth=.5*this.width,this.halfHeight=.5*this.height,this):void 0},clear:function(){return this},render:function(){return this}},FSS.CanvasRenderer=function(){FSS.Renderer.call(this),this.element=document.createElement("canvas"),this.element.style.display="block",this.context=this.element.getContext("2d"),this.setSize(this.element.width,this.element.height)},FSS.CanvasRenderer.prototype=Object.create(FSS.Renderer.prototype),FSS.CanvasRenderer.prototype.setSize=function(e,t){return FSS.Renderer.prototype.setSize.call(this,e,t),this.element.width=e,this.element.height=t,this.context.setTransform(1,0,0,-1,this.halfWidth,this.halfHeight),this},FSS.CanvasRenderer.prototype.clear=function(){return FSS.Renderer.prototype.clear.call(this),this.context.clearRect(-this.halfWidth,-this.halfHeight,this.width,this.height),this},FSS.CanvasRenderer.prototype.render=function(e){FSS.Renderer.prototype.render.call(this,e);var t,i,r,n,o;for(this.clear(),this.context.lineJoin="round",this.context.lineWidth=1,t=e.meshes.length-1;t>=0;t--)if(i=e.meshes[t],i.visible)for(i.update(e.lights,!0),r=i.geometry.triangles.length-1;r>=0;r--)n=i.geometry.triangles[r],o=n.color.format(),this.context.beginPath(),this.context.moveTo(n.a.position[0],n.a.position[1]),this.context.lineTo(n.b.position[0],n.b.position[1]),this.context.lineTo(n.c.position[0],n.c.position[1]),this.context.closePath(),this.context.strokeStyle=o,this.context.fillStyle=o,this.context.stroke(),this.context.fill();return this},FSS.WebGLRenderer=function(){FSS.Renderer.call(this),this.element=document.createElement("canvas"),this.element.style.display="block",this.vertices=null,this.lights=null;var e={preserveDrawingBuffer:!1,premultipliedAlpha:!0,antialias:!0,stencil:!0,alpha:!0};return this.gl=this.getContext(this.element,e),this.unsupported=!this.gl,this.unsupported?"WebGL is not supported by your browser.":(this.gl.clearColor(0,0,0,0),this.gl.enable(this.gl.DEPTH_TEST),this.setSize(this.element.width,this.element.height),void 0)},FSS.WebGLRenderer.prototype=Object.create(FSS.Renderer.prototype),FSS.WebGLRenderer.prototype.getContext=function(e,t){var i=!1;try{!(i=e.getContext("experimental-webgl",t))}catch(r){console.error(r)}return i},FSS.WebGLRenderer.prototype.setSize=function(e,t){return FSS.Renderer.prototype.setSize.call(this,e,t),this.unsupported?void 0:(this.element.width=e,this.element.height=t,this.gl.viewport(0,0,e,t),this)},FSS.WebGLRenderer.prototype.clear=function(){return FSS.Renderer.prototype.clear.call(this),this.unsupported?void 0:(this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this)},FSS.WebGLRenderer.prototype.render=function(e){if(FSS.Renderer.prototype.render.call(this,e),!this.unsupported){var t,i,r,n,o,s,a,h,l,u,c,d,f,S,g,m=!1,p=e.lights.length,F=0;if(this.clear(),this.lights!==p){if(this.lights=p,!(this.lights>0))return;this.buildProgram(p)}if(this.program){for(t=e.meshes.length-1;t>=0;t--)i=e.meshes[t],i.geometry.dirty&&(m=!0),i.update(e.lights,!1),F+=3*i.geometry.triangles.length;if(m||this.vertices!==F){this.vertices=F;for(h in this.program.attributes){for(u=this.program.attributes[h],u.data=new FSS.Array(F*u.size),f=0,t=e.meshes.length-1;t>=0;t--)for(i=e.meshes[t],r=0,n=i.geometry.triangles.length;n>r;r++)for(o=i.geometry.triangles[r],S=0,g=o.vertices.length;g>S;S++){switch(vertex=o.vertices[S],h){case"side":this.setBufferData(f,u,i.side);break;case"position":this.setBufferData(f,u,vertex.position);break;case"centroid":this.setBufferData(f,u,o.centroid);break;case"normal":this.setBufferData(f,u,o.normal);break;case"ambient":this.setBufferData(f,u,i.material.ambient.rgba);break;case"diffuse":this.setBufferData(f,u,i.material.diffuse.rgba)}f++}this.gl.bindBuffer(this.gl.ARRAY_BUFFER,u.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,u.data,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(u.location),this.gl.vertexAttribPointer(u.location,u.size,this.gl.FLOAT,!1,0,0)}}for(this.setBufferData(0,this.program.uniforms.resolution,[this.width,this.height,this.width]),s=p-1;s>=0;s--)a=e.lights[s],this.setBufferData(s,this.program.uniforms.lightPosition,a.position),this.setBufferData(s,this.program.uniforms.lightAmbient,a.ambient.rgba),this.setBufferData(s,this.program.uniforms.lightDiffuse,a.diffuse.rgba);for(l in this.program.uniforms)switch(u=this.program.uniforms[l],d=u.location,c=u.data,u.structure){case"3f":this.gl.uniform3f(d,c[0],c[1],c[2]);break;case"3fv":this.gl.uniform3fv(d,c);break;case"4fv":this.gl.uniform4fv(d,c)}}return this.gl.drawArrays(this.gl.TRIANGLES,0,this.vertices),this}},FSS.WebGLRenderer.prototype.setBufferData=function(e,t,i){if(FSS.Utils.isNumber(i))t.data[e*t.size]=i;else for(var r=i.length-1;r>=0;r--)t.data[e*t.size+r]=i[r]},FSS.WebGLRenderer.prototype.buildProgram=function(e){if(!this.unsupported){var t=FSS.WebGLRenderer.VS(e),i=FSS.WebGLRenderer.FS(e),r=t+i;if(!this.program||this.program.code!==r){var n=this.gl.createProgram(),o=this.buildShader(this.gl.VERTEX_SHADER,t),s=this.buildShader(this.gl.FRAGMENT_SHADER,i);if(this.gl.attachShader(n,o),this.gl.attachShader(n,s),this.gl.linkProgram(n),!this.gl.getProgramParameter(n,this.gl.LINK_STATUS)){var a=this.gl.getError(),h=this.gl.getProgramParameter(n,this.gl.VALIDATE_STATUS);return console.error("Could not initialise shader.\nVALIDATE_STATUS: "+h+"\nERROR: "+a),null}return this.gl.deleteShader(s),this.gl.deleteShader(o),n.code=r,n.attributes={side:this.buildBuffer(n,"attribute","aSide",1,"f"),position:this.buildBuffer(n,"attribute","aPosition",3,"v3"),centroid:this.buildBuffer(n,"attribute","aCentroid",3,"v3"),normal:this.buildBuffer(n,"attribute","aNormal",3,"v3"),ambient:this.buildBuffer(n,"attribute","aAmbient",4,"v4"),diffuse:this.buildBuffer(n,"attribute","aDiffuse",4,"v4")},n.uniforms={resolution:this.buildBuffer(n,"uniform","uResolution",3,"3f",1),lightPosition:this.buildBuffer(n,"uniform","uLightPosition",3,"3fv",e),lightAmbient:this.buildBuffer(n,"uniform","uLightAmbient",4,"4fv",e),lightDiffuse:this.buildBuffer(n,"uniform","uLightDiffuse",4,"4fv",e)},this.program=n,this.gl.useProgram(this.program),n}}},FSS.WebGLRenderer.prototype.buildShader=function(e,t){if(!this.unsupported){var i=this.gl.createShader(e);return this.gl.shaderSource(i,t),this.gl.compileShader(i),this.gl.getShaderParameter(i,this.gl.COMPILE_STATUS)?i:(console.error(this.gl.getShaderInfoLog(i)),null)}},FSS.WebGLRenderer.prototype.buildBuffer=function(e,t,i,r,n,o){var s={buffer:this.gl.createBuffer(),size:r,structure:n,data:null};switch(t){case"attribute":s.location=this.gl.getAttribLocation(e,i);break;case"uniform":s.location=this.gl.getUniformLocation(e,i)}return o&&(s.data=new FSS.Array(o*r)),s},FSS.WebGLRenderer.VS=function(e){var t=["precision mediump float;","#define LIGHTS "+e,"attribute float aSide;","attribute vec3 aPosition;","attribute vec3 aCentroid;","attribute vec3 aNormal;","attribute vec4 aAmbient;","attribute vec4 aDiffuse;","uniform vec3 uResolution;","uniform vec3 uLightPosition[LIGHTS];","uniform vec4 uLightAmbient[LIGHTS];","uniform vec4 uLightDiffuse[LIGHTS];","varying vec4 vColor;","void main() {","vColor = vec4(0.0);","vec3 position = aPosition / uResolution * 2.0;","for (int i = 0; i < LIGHTS; i++) {","vec3 lightPosition = uLightPosition[i];","vec4 lightAmbient = uLightAmbient[i];","vec4 lightDiffuse = uLightDiffuse[i];","vec3 ray = normalize(lightPosition - aCentroid);","float illuminance = dot(aNormal, ray);","if (aSide == 0.0) {","illuminance = max(illuminance, 0.0);","} else if (aSide == 1.0) {","illuminance = abs(min(illuminance, 0.0));","} else if (aSide == 2.0) {","illuminance = max(abs(illuminance), 0.0);","}","vColor += aAmbient * lightAmbient;","vColor += aDiffuse * lightDiffuse * illuminance;","}","vColor = clamp(vColor, 0.0, 1.0);","gl_Position = vec4(position, 1.0);","}"].join("\n");return t},FSS.WebGLRenderer.FS=function(){var e=["precision mediump float;","varying vec4 vColor;","void main() {","gl_FragColor = vColor;","}"].join("\n");return e},FSS.SVGRenderer=function(){FSS.Renderer.call(this),this.element=document.createElementNS(FSS.SVGNS,"svg"),this.element.setAttribute("xmlns",FSS.SVGNS),this.element.setAttribute("version","1.1"),this.element.style.display="block",this.setSize(300,150)},FSS.SVGRenderer.prototype=Object.create(FSS.Renderer.prototype),FSS.SVGRenderer.prototype.setSize=function(e,t){return FSS.Renderer.prototype.setSize.call(this,e,t),this.element.setAttribute("width",e),this.element.setAttribute("height",t),this},FSS.SVGRenderer.prototype.clear=function(){FSS.Renderer.prototype.clear.call(this);for(var e=this.element.childNodes.length-1;e>=0;e--)this.element.removeChild(this.element.childNodes[e]);return this},FSS.SVGRenderer.prototype.render=function(e){FSS.Renderer.prototype.render.call(this,e);var t,i,r,n,o,s;for(t=e.meshes.length-1;t>=0;t--)if(i=e.meshes[t],i.visible)for(i.update(e.lights,!0),r=i.geometry.triangles.length-1;r>=0;r--)n=i.geometry.triangles[r],n.polygon.parentNode!==this.element&&this.element.appendChild(n.polygon),o=this.formatPoint(n.a)+" ",o+=this.formatPoint(n.b)+" ",o+=this.formatPoint(n.c),s=this.formatStyle(n.color.format()),n.polygon.setAttributeNS(null,"points",o),n.polygon.setAttributeNS(null,"style",s);return this},FSS.SVGRenderer.prototype.formatPoint=function(e){return this.halfWidth+e.position[0]+","+(this.halfHeight-e.position[1])},FSS.SVGRenderer.prototype.formatStyle=function(e){var t="fill:"+e+";";return t+="stroke:"+e+";"};var MESH={width:1.2,height:1.2,slices:Wata.triangles.mesh.slices,depth:Wata.triangles.mesh.depth,maxdepth:200,ambient:"#555555",diffuse:"#FFFFFF"},LIGHT={count:0,xPos:68,yPos:440,zOffset:Wata.triangles.light.distance,ambient:Wata.triangles.light.ambient,diffuse:Wata.triangles.light.diffuse,pickedup:!0,proxy:!1,currIndex:0,randomize:function(){var e,t,i,r=Math.floor(3*Math.random())+1;for(1==r&&(MESH.depth=0),2==r&&(MESH.depth=Math.randomInRange(0,150)),3==r&&(MESH.depth=Math.randomInRange(150,200)),MESH.depth=0,l=scene.lights.length-1;l>=0;l--){e=Math.randomInRange(-mesh.geometry.width/2,mesh.geometry.width/2),t=Math.randomInRange(-mesh.geometry.height/2,mesh.geometry.height/2),i=scene.lights.length>2?Math.randomInRange(10,80):Math.randomInRange(10,100),light=scene.lights[l],FSS.Vector3.set(light.position,e,t,i);var n=this.diffuse,o=this.ambient;light.diffuseHex=light.diffuse.format(),light.ambientHex=light.ambient.format(),LIGHT.xPos=e,LIGHT.yPos=t,LIGHT.zOffset=i,LIGHT.diffuse=n,LIGHT.ambient=o,gui.__folders.Light.__controllers[1].updateDisplay(),gui.__folders.Light.__controllers[2].updateDisplay()}}},WEBGL="webgl",CANVAS="canvas",SVG="svg",RENDER={renderer:CANVAS},EXPORT={width:2e3,height:1e3,exportCurrent:function(){switch(RENDER.renderer){case WEBGL:window.open(webglRenderer.element.toDataURL(),"_blank");break;case CANVAS:window.open(canvasRenderer.element.toDataURL(),"_blank");break;case SVG:var e=encodeURIComponent(output.innerHTML),t="data:image/svg+xml,"+e;window.open(t,"_blank")}},"export":function(){var e,t,i,r,n=this.width/renderer.width,o=this.height/renderer.height,s=MESH.slices;for(MESH.slices=Math.ceil(1.4*s*n),resize(this.width,this.height),MESH.slices=s,e=scene.lights.length-1;e>=0;e--)r=scene.lights[e],t=r.position[0],i=r.position[1],z=r.position[2],FSS.Vector3.set(r.position,t*n,i*o,z*n);switch(update(),render(),RENDER.renderer){case WEBGL:window.open(webglRenderer.element.toDataURL(),"_blank");break;case CANVAS:window.open(canvasRenderer.element.toDataURL(),"_blank");break;case SVG:var a=encodeURIComponent(output.innerHTML),h="data:image/svg+xml,"+a;window.open(h,"_blank")}for(resize(container.offsetWidth,container.offsetHeight),e=scene.lights.length-1;e>=0;e--)r=scene.lights[e],t=r.position[0],i=r.position[1],z=r.position[2],FSS.Vector3.set(r.position,t/n,i/o,z/n)}},center=FSS.Vector3.create(),container=document.getElementById("triangles"),controls=document.getElementById("controls"),output=document.getElementById("output"),renderer,scene,mesh,geometry,material,webglRenderer,canvasRenderer,svgRenderer,gui;LIGHT.pickedup=!0,initialise();